<!DOCTYPE html>
<meta charset="utf-8">
<script type="text/javascript" src="../static/lib/d3.v5.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">

<link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-bootstrap/0.5pre/css/custom-theme/jquery-ui-1.10.0.custom.css" rel="stylesheet"/>
<link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.css" rel="stylesheet"/>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.2/jquery-ui.js"></script>

<!-- CSS styling  -->
<style>
    .main-grid {
        display: grid;
        grid-template-columns: 24vw 65vw;
        grid-gap: 1vw;
        padding: 5px 5px 5px 5px;
    }
    .liked-songs {
        display: flex;
        height: 40vh;
        flex-direction: column;
        justify-content: flex-start;
    }
    #song-search {
        display: flex;
        flex-direction: row;
    }
    .slider-container {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
        height: 40vh;
    }
    .slider {
        width: 80%;
    }
    path.link {
        fill: none;
        stroke: #666;
        stroke-width: 1.5px;
    }
    .node {
        stroke: black;
        stroke-width: 1.5px;
    }
    .spinner-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
    }


</style>

<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
<!-- Head  -->
<head>
    <title>
        Song Recommender
    </title>
</head>

<!-- Body  -->
<body>
    <h1 style="text-align:center;height:5vh;"> Song Recommender </h1>
    <div class="main-grid">
        <div class="grid-child left">
            <form class="liked-songs">
                <div class="form-group mx-sm-3 mb-2" id="song-search">
                    <input class="form-control" id="inputSong" placeholder="Song Name">
                    <div style="width:5px"></div> <!-- This is to put space between the input box and button -->
                    <button type="button" class="btn btn-primary mb-2" onclick="updateSongInput()">Update Song</button>
                </div>
                <ul class="list-group" id="song-list"></ul>
            </form>

            <div class="slider-container">
                <div class="slider-text" style="text-align:center">
                    <h3>Similarity Weights</h3>
                    <p>
                        These sliders represent how similar each feature will be in the recommended songs
                    </p>
                </div>
                <div class="slider">
                    <label class ="attr" style="color:#060558">
                        Popularity
                    </label>
                    <div class="d-flex align-items-center my-2">
                        <span class="font-weight-bold indigo-text mr-2 mt-1">0</span>
                        <form class="range-field w-100">
                            <input class="border-0" type="range" min="0" max="100" />
                        </form>
                        <span class="font-weight-bold indigo-text ml-2 mt-1">100</span>
                    </div>
                </div>
                <div class="slider">
                    <label class="attr" style="color:#064da6">
                        Release Date
                    </label>
                    <div class="d-flex align-items-center my-2">
                        <span class="font-weight-bold indigo-text mr-2 mt-1">0</span>
                        <form class="range-field w-100">
                            <input class="border-0" type="range" min="0" max="100" />
                        </form>
                        <span class="font-weight-bold indigo-text ml-2 mt-1">100</span>
                    </div>
                </div>
                <div class="slider">
                    <label class ="attr" style="color:#01bef0">
                        Danceability
                    </label>
                    <div class="d-flex align-items-center my-2">
                        <span class="font-weight-bold indigo-text mr-2 mt-1">0</span>
                        <form class="range-field w-100 ">
                            <input type="range" min="0" max="100" />
                        </form>
                        <span class="font-weight-bold indigo-text ml-2 mt-1">100</span>
                    </div>
                </div>
            </div>
            
        </div>
        <div class="grid-child middle" id="canvas">
            <div class="spinner-container" id="loadingGraph" style="display: none;">
                <div class="spinner-grow text-primary" style="width: 5rem; height: 5rem;" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    <script>
        function updateSongInput(songName = null) {
            d3.select("svg").remove()
            $('#loadingGraph').show()
            if(!songName) {
                songName = $('#inputSong').val()
            }
            fetch(`/getdata/${songName}`)
                .then(response => response.json())
                .then(kSimilarSongs => {
                    // turn kSimilarSongs into nodes format
                    var nodes = {};
                    console.log(kSimilarSongs)
                    kSimilarSongs.forEach(song => {
                        nodes[song[0]] = {id: song[0], song_name: song[1], song_artist: song[2], weight: song[3], parent: song[4]}
                    });
                    $('#loadingGraph').hide()
                    buildGraph(nodes)
                })
                .catch(function() {
                    console.log("Error finding song: " + songName);
                });
        }
        
        function buildGraph(nodes) {
            var edges = [];
            for (const [key, value] of Object.entries(nodes)) {
                if (value.parent) {
                    var newEdge = {source: value.parent, target: key};
                    edges.push(newEdge);
                }
            }
            console.log(nodes);
            console.log(edges);

            var width = window.innerWidth * 0.65;
            var height = window.innerHeight * 0.90;

            var force = d3.forceSimulation()
                .nodes(d3.values(nodes))
                .force("link", d3.forceLink(edges).id(d => d.id).distance(100))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force("x", d3.forceX())
                .force("y", d3.forceY())
                .force("charge", d3.forceManyBody().strength(-300))
                .alphaTarget(1)
                .on("tick", tick);

            var svg = d3.select("#canvas").append("svg")
                .attr("width", width)
                .attr("height", height);

            var path = svg.append("g")
                .selectAll("path")
                .data(edges)
                .enter()
                .append("path")
                .attr("class", function(d) { return "link " + d.type; })
                .style("stroke-width", "3px");

            var node = svg.selectAll(".node")
                .data(force.nodes())
                .enter().append("g")
                .attr("class", "node")
                .on("click", nodeClicked)
                .on("mouseover", nodeMouseover)
                .on("mouseout", nodeMouseout)
            
            node.append("circle")
                .attr("class", "unpinned")
                .attr("r", function(d) {
                    const minRadius = 10;
                    const maxRadius = 50;
                    return (maxRadius / (maxRadius + 2 * d.weight)) * (maxRadius-minRadius) + minRadius;
                })
                .style("fill", "#01bef0")
                .style("stroke", "blue");

            var label = node.append("svg:text")
                .text(function (d) { return truncateString(d.song_name, 20); })
                .style("font", "14px sans-serif")
                .style("font-weight", "bold")
                .style("stroke-width", "0")
                .style("fill", "#000")
                .style('text-anchor', 'middle');

            function truncateString(str, len) {
                if (str.length <= len) {
                    return str;
                } else {
                    return str.slice(0, len-3) + '...';
                }
            }

            function tick() {
                path.attr("d", function(d) {
                    var dx = d.target.x - d.source.x,
                        dy = d.target.y - d.source.y,
                        // dr = Math.sqrt(dx * dx + dy * dy);
                        dr = 0;
                    return "M" +
                        d.source.x + "," +
                        d.source.y + "A" +
                        dr + "," + dr + " 0 0,1 " +
                        d.target.x + "," +
                        d.target.y;
                });

                node.attr("transform", function(d) {
                    return "translate(" + d.x + "," + d.y + ")"; 
                });
            };

            function nodeClicked(d) {
                updateSongInput(d.song_name);
                $('#inputSong').val(d.song_name);
            };

            function nodeMouseover(d) {
                d3.select(this).style("cursor", "pointer")
                    .transition()
                    .duration('200')
                    .attr('opacity', '.7');
            };

            function nodeMouseout(d) {
                d3.select(this).transition()
                    .duration('200')
                    .attr('opacity', '1');
            };

            function getNodeSize(similarity) {
                const minSize = 10;
                const maxSize = 50;
            }
        }
    </script>


<body>
