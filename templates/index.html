<!DOCTYPE html>
<meta charset="utf-8">
<script type="text/javascript" src="../static/lib/d3.v5.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">

<link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-bootstrap/0.5pre/css/custom-theme/jquery-ui-1.10.0.custom.css" rel="stylesheet"/>
<link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.css" rel="stylesheet"/>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.2/jquery-ui.js"></script>

<!-- CSS styling  -->
<style>
    .main-grid {
        display: grid;
        grid-template-columns: 24vw 65vw;
        grid-gap: 1vw;
        padding: 5px 5px 5px 5px;
    }
    .liked-songs {
        display: flex;
        height: 40vh;
        flex-direction: column;
        justify-content: flex-start;
    }
    #song-search {
        display: flex;
        flex-direction: row;
    }
    .slider-container {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
        height: 40vh;
    }
    .slider {
        width: 80%;
    }
    path.link {
        fill: none;
        stroke: #666;
        stroke-width: 1.5px;
    }
    .node {
        fill: #ccc;
        stroke: #fff;
        stroke: black;
        stroke-width: 1.5px;
    }

</style>

<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
<!-- Head  -->
<head>
    <title>
        Song Recommender
    </title>
</head>

<!-- Body  -->
<body>
    <h1 style="text-align:center;height:5vh;"> Song Recommender </h1>
    <div class="main-grid">
        <div class="grid-child left">
            <!-- <div class="form-group">
                <label>Languages</label>
                <input class="form-control autocomplete" placeholder="Enter a song" />
            </div> -->

            <!-- TODO: add autocomplete -->
            <form class="liked-songs">
                <div class="form-group mx-sm-3 mb-2" id="song-search">
                    <input class="form-control" id="inputSong" placeholder="Song Name">
                    <div style="width:5px"></div> <!-- This is to put space between the input box and button -->
                    <button type="button" class="btn btn-primary mb-2" onclick="updateSongInput()">Update Song</button>
                </div>
                <ul class="list-group" id="song-list"></ul>
            </form>

            <div class="slider-container">
                <div class="slider-text" style="text-align:center">
                    <h3>Similarity Weights</h3>
                    <p>
                        These sliders represent how similar each feature will be in the recommended songs
                    </p>
                </div>
                <div class="slider">
                    <label class ="attr" style="color:#060558">
                        Popularity
                    </label>
                    <div class="d-flex align-items-center my-2">
                        <span class="font-weight-bold indigo-text mr-2 mt-1">0</span>
                        <form class="range-field w-100">
                            <input class="border-0" type="range" min="0" max="100" />
                        </form>
                        <span class="font-weight-bold indigo-text ml-2 mt-1">100</span>
                    </div>
                </div>
                <div class="slider">
                    <label class="attr" style="color:#064da6">
                        Release Date
                    </label>
                    <div class="d-flex align-items-center my-2">
                        <span class="font-weight-bold indigo-text mr-2 mt-1">0</span>
                        <form class="range-field w-100">
                            <input class="border-0" type="range" min="0" max="100" />
                        </form>
                        <span class="font-weight-bold indigo-text ml-2 mt-1">100</span>
                    </div>
                </div>
                <div class="slider">
                    <label class ="attr" style="color:#01bef0">
                        Danceability
                    </label>
                    <div class="d-flex align-items-center my-2">
                        <span class="font-weight-bold indigo-text mr-2 mt-1">0</span>
                        <form class="range-field w-100 ">
                            <input type="range" min="0" max="100" />
                        </form>
                        <span class="font-weight-bold indigo-text ml-2 mt-1">100</span>
                    </div>
                </div>
            </div>
            
        </div>
        <div class="grid-child middle" id="canvas">
            

            
        </div>
    </div>
    <script>
        function updateSongInput() {
            songId = $('#inputSong').val()
            fetch(`/getdata/${songId}`)
                .then(response => response.json())
                .then(kSimilarSongs => {
                    // TODO: turn kSimilarSongs into nodes format
                    var nodes = {};
                    kSimilarSongs.forEach(song => {
                        nodes[song[0]] = {id: song[0], song_name: song[1], weight: song[2], parent: song[3]}
                    });
                    buildGraph(nodes)
                });
        }

        // for autocomplete
        $(function() {
            // TODO load from a file containing track names instead of these placeholders
            var availableTags = [
                "ActionScript", "AppleScript", "Asp", "BASIC", "C", "C++",
                "Clojure", "COBOL", "ColdFusion", "Erlang", "Fortran",
                "Groovy", "Haskell", "Java", "JavaScript", "Lisp", "Perl",
                "PHP", "Python", "Ruby", "Scala", "Scheme"
            ];

            $(".autocomplete").autocomplete({
                source: availableTags
            });
        });

        //sample data for nodes and edges
        // var nodes = {123: {id: 123, song_name: 'Fireworks', weight: 1, parent: null}, 20: {id: 20, song_name: 'Toxic', weight: 0.8, parent: 123}}
        // buildGraph(nodes)
        
        function buildGraph(nodes) {
            d3.select("svg").remove()

            var edges = [];
            for (const [key, value] of Object.entries(nodes)) {
                if (value.parent) {
                    var newEdge = {source: value.parent, target: key};
                    edges.push(newEdge);
                }
            }
            console.log(nodes);
            console.log(edges);

            var width = 1000;
            var height = 600;

            var force = d3.forceSimulation()
                .nodes(d3.values(nodes))
                .force("link", d3.forceLink(edges).id(d => d.id).distance(100))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force("x", d3.forceX())
                .force("y", d3.forceY())
                .force("charge", d3.forceManyBody().strength(-250))
                .alphaTarget(1)
                .on("tick", tick);

            var svg = d3.select("#canvas").append("svg")
                .attr("width", width)
                .attr("height", height);

            var path = svg.append("g")
                .selectAll("path")
                .data(edges)
                .enter()
                .append("path")
                .attr("class", function(d) { return "link " + d.type; });

            var node = svg.selectAll(".node")
                .data(force.nodes())
                .enter().append("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));
            
            node.append("circle")
                .attr("class", "unpinned")
                .attr("r", 5);

            function tick() {
                path.attr("d", function(d) {
                    var dx = d.target.x - d.source.x,
                        dy = d.target.y - d.source.y,
                        // dr = Math.sqrt(dx * dx + dy * dy);
                        dr = 0;
                    return "M" +
                        d.source.x + "," +
                        d.source.y + "A" +
                        dr + "," + dr + " 0 0,1 " +
                        d.target.x + "," +
                        d.target.y;
                });

                node.attr("transform", function(d) {
                    return "translate(" + d.x + "," + d.y + ")"; 
                });
            };
        }

        function dragstarted(d) {
            if (!d3.event.active) force.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
            d3.select(this).select("circle").style("stroke-width", 3);
        };

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        };

        function dragended(d) {
            if (!d3.event.active) force.alphaTarget(0);
            d.fixed = true;
            if (d.fixed == true) {
                d.fx = d.x;
                d.fy = d.y;
            }
            else {
                d.fx = null;
                d.fy = null;
            }
        };
    </script>


<body>
